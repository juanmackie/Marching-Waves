<!DOCTYPE html>
<html>
<head>
    <title>Complete Test - Marching Waves Fix</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .test-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .test-card { border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; }
        .test-card h3 { margin-top: 0; color: #007bff; }
        canvas { width: 100%; height: auto; border: 1px solid #ccc; background: white; }
        .status { padding: 12px; margin: 10px 0; border-radius: 4px; text-align: center; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .console { background: #1a1a1a; color: #0f0; padding: 15px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 200px; overflow-y: auto; margin: 15px 0; }
        .result { padding: 10px; background: #e9ecef; border-radius: 4px; margin: 10px 0; }
        .passed { color: #28a745; font-weight: bold; }
        .failed { color: #dc3545; font-weight: bold; }
        .svg-preview { border: 1px solid #ddd; padding: 10px; margin: 10px 0; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Complete Test - Marching Waves Fix</h1>
        <div id="status" class="status">Ready to test</div>
        
        <div class="test-grid">
            <div class="test-card">
                <h3>Normal Mode</h3>
                <canvas id="normalCanvas" width="200" height="200"></canvas>
                <div id="normalResult" class="result">Pending...</div>
                <div id="normalSVG" class="svg-preview"></div>
            </div>
            
            <div class="test-card">
                <h3>Grayscale Debug</h3>
                <canvas id="grayscaleCanvas" width="200" height="200"></canvas>
                <div id="grayscaleResult" class="result">Pending...</div>
                <div id="grayscaleSVG" class="svg-preview"></div>
            </div>
            
            <div class="test-card">
                <h3>Heatmap Debug</h3>
                <canvas id="heatmapCanvas" width="200" height="200"></canvas>
                <div id="heatmapResult" class="result">Pending...</div>
                <div id="heatmapSVG" class="svg-preview"></div>
            </div>
            
            <div class="test-card">
                <h3>Raw Debug</h3>
                <canvas id="rawCanvas" width="200" height="200"></canvas>
                <div id="rawResult" class="result">Pending...</div>
                <div id="rawSVG" class="svg-preview"></div>
            </div>
        </div>
        
        <div class="console" id="console"></div>
        
        <button id="runAllTests">Run All Tests</button>
    </div>
    
    <script>
        // Complete test implementation
        class CompleteTestMarchingWaves {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                this.debugMode = false;
                this.vizMode = 'final';
                this.showOrigins = true;
            }
            
            async processImage(options) {
                this.debugMode = options.debugMode || false;
                this.vizMode = options.vizMode || 'final';
                this.showOrigins = options.showOrigins !== false;
                
                const width = 200;
                const height = 200;
                this.canvas.width = width;
                this.canvas.height = height;
                
                console.log(`Processing ${this.vizMode} mode (debug: ${this.debugMode})`);
                
                if (this.debugMode && this.vizMode !== 'final') {
                    await new Promise(r => setTimeout(r, 10));
                    this.renderDebugVisualization(width, height, options.lineColor, options.lineWidth);
                    console.log('Debug visualization rendered to canvas');
                    
                    // Return informative SVG for debug mode
                    const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
  <rect width="${width}" height="${height}" fill="white"/>
  <text x="${width/2}" y="${height/2}" text-anchor="middle" fill="black" font-size="16">Debug Mode: ${this.vizMode}</text>
</svg>`;
                    
                    console.log('Debug SVG generated');
                    return svg;
                }
                
                // Normal mode
                console.log('Normal mode processing');
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(0, 0, width, height);
                this.ctx.strokeStyle = options.lineColor;
                this.ctx.lineWidth = options.lineWidth;
                this.ctx.beginPath();
                this.ctx.moveTo(50, 50);
                this.ctx.lineTo(150, 150);
                this.ctx.moveTo(50, 150);
                this.ctx.lineTo(150, 50);
                this.ctx.stroke();
                
                const svg = this.getSVG(width, height, options.lineColor, options.lineWidth);
                console.log('Normal SVG generated');
                return svg;
            }
            
            renderDebugVisualization(width, height, lineColor, lineWidth) {
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(0, 0, width, height);
                
                if (this.vizMode === 'grayscale') {
                    console.log('Creating grayscale visualization');
                    const imgData = this.ctx.createImageData(width, height);
                    for (let i = 0; i < width * height; i++) {
                        const val = Math.floor((i / (width * height)) * 255);
                        imgData.data[i * 4] = val;
                        imgData.data[i * 4 + 1] = val;
                        imgData.data[i * 4 + 2] = val;
                        imgData.data[i * 4 + 3] = 255;
                    }
                    this.ctx.putImageData(imgData, 0, 0);
                } else if (this.vizMode === 'heatmap') {
                    console.log('Creating heatmap visualization');
                    const imgData = this.ctx.createImageData(width, height);
                    for (let i = 0; i < width * height; i++) {
                        const x = i % width;
                        const y = Math.floor(i / width);
                        const t = (x + y) / (width + height);
                        const r = Math.floor(t * 255);
                        const b = Math.floor((1 - t) * 255);
                        imgData.data[i * 4] = r;
                        imgData.data[i * 4 + 1] = 0;
                        imgData.data[i * 4 + 2] = b;
                        imgData.data[i * 4 + 3] = 255;
                    }
                    this.ctx.putImageData(imgData, 0, 0);
                } else if (this.vizMode === 'raw') {
                    console.log('Creating raw contour visualization');
                    this.ctx.strokeStyle = lineColor;
                    this.ctx.lineWidth = lineWidth * 0.5;
                    this.ctx.beginPath();
                    
                    // Draw grid
                    for (let y = 20; y < height; y += 20) {
                        this.ctx.moveTo(10, y);
                        this.ctx.lineTo(width - 10, y);
                    }
                    for (let x = 20; x < width; x += 20) {
                        this.ctx.moveTo(x, 10);
                        this.ctx.lineTo(x, height - 10);
                    }
                    this.ctx.stroke();
                }
                
                // Show origin points if enabled
                if (this.showOrigins) {
                    this.ctx.fillStyle = 'red';
                    for (let i = 0; i < 3; i++) {
                        const x = Math.random() * width;
                        const y = Math.random() * height;
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, 3, 0, Math.PI * 2);
                        this.ctx.fill();
                    }
                }
            }
            
            getSVG(width, height, lineColor, lineWidth) {
                return `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">
  <rect width="${width}" height="${height}" fill="white"/>
  <g stroke="${lineColor}" stroke-width="${lineWidth}" fill="none">
    <line x1="50" y1="50" x2="150" y2="150"/>
    <line x1="50" y1="150" x2="150" y2="50"/>
  </g>
</svg>`;
            }
        }
        
        function showStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = 'status ' + type;
        }
        
        function updateTestResult(canvasId, message, isSuccess, svgContent) {
            const resultEl = document.getElementById(canvasId.replace('Canvas', 'Result'));
            const svgEl = document.getElementById(canvasId.replace('Canvas', 'SVG'));
            
            resultEl.innerHTML = isSuccess 
                ? `<span class="passed">‚úì ${message}</span>`
                : `<span class="failed">‚úó ${message}</span>`;
            
            svgEl.textContent = svgContent ? svgContent.substring(0, 300) + '...' : '';
        }
        
        // Console redirection
        const consoleEl = document.getElementById('console');
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return String(arg);
            }).join(' ');
            
            const logEl = document.createElement('div');
            logEl.textContent = message;
            consoleEl.appendChild(logEl);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            const message = args.map(arg => {
                if (typeof arg === 'object') {
                    return JSON.stringify(arg, null, 2);
                }
                return String(arg);
            }).join(' ');
            
            const errorEl = document.createElement('div');
            errorEl.textContent = 'ERROR: ' + message;
            errorEl.style.color = '#ff4444';
            consoleEl.appendChild(errorEl);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        };
        
        async function runTest(canvasId, mode, isDebug) {
            try {
                console.log(`\n=== Testing ${mode} ===`);
                
                const waves = new CompleteTestMarchingWaves(canvasId);
                
                const result = await waves.processImage({
                    debugMode: isDebug,
                    vizMode: mode.toLowerCase(),
                    lineColor: '#000000',
                    lineWidth: 1,
                    showOrigins: true
                });
                
                // Check if canvas has content
                const ctx = waves.ctx;
                const imageData = ctx.getImageData(0, 0, 200, 200);
                const data = imageData.data;
                
                let hasContent = false;
                for (let i = 0; i < data.length; i += 4) {
                    if (data[i] !== 255 || data[i + 1] !== 255 || data[i + 2] !== 255) {
                        hasContent = true;
                        break;
                    }
                }
                
                if (hasContent) {
                    updateTestResult(canvasId, `${mode} mode working`, true, result);
                    console.log(`‚úì ${mode}: Canvas has visual content`);
                    console.log(`‚úì ${mode}: SVG length: ${result.length}`);
                    return true;
                } else {
                    updateTestResult(canvasId, `${mode} mode failed - blank canvas`, false, result);
                    console.log(`‚úó ${mode}: Canvas is blank`);
                    return false;
                }
                
            } catch (error) {
                updateTestResult(canvasId, `${mode} mode error: ${error.message}`, false, '');
                console.error(`‚úó ${mode}:`, error);
                return false;
            }
        }
        
        async function runAllTests() {
            consoleEl.innerHTML = '';
            showStatus('Running complete tests...', 'info');
            
            const results = [];
            
            // Test normal mode
            results.push(await runTest('normalCanvas', 'Normal', false));
            
            // Test debug modes
            results.push(await runTest('grayscaleCanvas', 'Grayscale', true));
            results.push(await runTest('heatmapCanvas', 'Heatmap', true));
            results.push(await runTest('rawCanvas', 'Raw', true));
            
            const allPassed = results.every(result => result);
            
            if (allPassed) {
                showStatus('üéâ All tests passed! Fix is working correctly.', 'success');
                console.log('\n=== FINAL RESULT ===');
                console.log('‚úÖ All visualization modes working');
                console.log('‚úÖ Canvas rendering correct');
                console.log('‚úÖ SVG generation appropriate for each mode');
                console.log('‚úÖ Fix implementation successful');
            } else {
                showStatus('‚ùå Some tests failed. Check console for details.', 'error');
                console.log('\n=== FINAL RESULT ===');
                console.log('‚ùå Some tests failed');
            }
        }
        
        document.getElementById('runAllTests').addEventListener('click', runAllTests);
        
        // Run automatically on page load
        window.addEventListener('load', function() {
            setTimeout(runAllTests, 100);
        });
    </script>
</body>
</html>